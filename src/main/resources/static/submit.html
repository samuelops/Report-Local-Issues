<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Report Local Issues — Submit</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    .status-chip { font-weight:600; font-size:12px; padding:4px 8px; border-radius:9999px; }
    /* modal backdrop */
    .modal-backdrop { background: rgba(0,0,0,0.5); }

    /* nav link base + hover */
  .nav-link {
    position: relative;
    padding: 6px 4px;
    transition: color 180ms ease, background-color 180ms ease;
  }
  .nav-link::after {
    /* subtle underline on hover/active */
    content: "";
    position: absolute;
    left: 0;
    bottom: -4px;
    height: 2px;
    width: 0%;
    background: linear-gradient(90deg, #06b6d4, #10b981);
    transition: width 220ms ease;
    border-radius: 2px;
  }
  .nav-link:hover {
    color: #0ea5a4; /* teal-ish hover color */
  }
  .nav-link:hover::after { width: 100%; }
  </style>
</head>
<body class="antialiased text-gray-800 bg-gray-50">

<!-- Header (same visual as index) -->
<header class="bg-white/60 backdrop-blur sticky top-0 z-30">
  <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
    <a href="/" class="flex items-center gap-3">
      <img src="/images/logo.png" alt="Report Local Issues Logo" class="w-10 h-10 rounded-md object-cover shadow bg-white"/>
      <div>
        <div class="text-sm font-semibold">Report Local Issues</div>
        <div class="text-xs text-gray-500 -mt-1">Community → Action</div>
      </div>
    </a>

    <nav class="hidden md:flex items-center gap-6 text-sm">
      <a href="/" class="nav-link">Home</a>
      <a href="/submit.html" class="text-teal-700 font-medium">Report Issue</a>
      <a href="/track.html" class="nav-link">Track Issue</a>
      <a href="/recent-map.html" class="nav-link">Recent Issues</a>
      <a href="/admin/complaints" class="px-3 py-1 rounded text-sm bg-gray-100 nav-link">Admin</a>
    </nav>

    <div class="md:hidden">
      <button id="mobileBtn" aria-label="Open menu" class="p-2 rounded-md hover:bg-gray-100">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
      </button>
    </div>
  </div>

  <div id="mobileMenu" class="md:hidden hidden bg-white/95 border-t">
    <div class="px-4 py-3 flex flex-col gap-2">
      <a href="/" class="py-2">Home</a>
      <a href="/submit.html" class="py-2 nav-link">Report Issue</a>
      <a href="/track.html" class="py-2 nav-link">Track Issue</a>
      <a href="/recent-map.html" class="py-2 nav-link">Recent Issues</a>
      <a href="/admin/complaints" class="py-2 nav-link">Admin</a>
    </div>
  </div>
</header>

<!-- Main container -->
<main class="py-12">
  <div class="max-w-3xl mx-auto px-4">

    <div class="bg-white shadow rounded-lg p-6">
      <h1 class="text-2xl font-semibold mb-3">Report an Issue</h1>
      <p class="text-sm text-gray-600 mb-4">Provide a clear title, description, and optional photo/location to help authorities act faster.</p>

      <form id="complaintForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium">Name *</label>
          <input id="name" name="name" required class="mt-1 block w-full rounded-md border-gray-300 p-2"/>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium">Email</label>
            <input id="email" name="email" type="email" class="mt-1 block w-full rounded-md border-gray-300 p-2"/>
          </div>
          <div>
            <label class="block text-sm font-medium">Phone</label>
            <input id="phone" name="phone" class="mt-1 block w-full rounded-md border-gray-300 p-2"/>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium">Title *</label>
          <input id="title" name="title" required class="mt-1 block w-full rounded-md border-gray-300 p-2"/>
        </div>

        <div>
          <label class="block text-sm font-medium">Description *</label>
          <textarea id="description" name="description" required rows="5" class="mt-1 block w-full rounded-md border-gray-300 p-2"></textarea>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium">Latitude</label>
            <input id="latitude" name="latitude" class="mt-1 block w-full rounded-md border-gray-300 p-2"/>
          </div>
          <div>
            <label class="block text-sm font-medium">Longitude</label>
            <input id="longitude" name="longitude" class="mt-1 block w-full rounded-md border-gray-300 p-2"/>
          </div>
        </div>

        <div class="mt-4">
          <label class="block text-sm font-medium">Pick location on map (optional)</label>
          <div id="mapPicker" class="w-full h-64 rounded border mt-2"></div>
          <div class="text-xs text-gray-500 mt-1">Click map to place marker, or use current location.</div>
        </div>

        <div>
          <label class="block text-sm font-medium">Address</label>
          <input id="address" name="address" class="mt-1 block w-full rounded-md border-gray-300 p-2"/>
        </div>

        <div>
          <label class="block text-sm font-medium">Image (optional)</label>
          <input id="image" name="image" type="file" accept="image/*" class="mt-1 block w-full"/>
        </div>

        <div class="flex items-center gap-3">
          <button id="submitBtn" type="submit" class="px-4 py-2 bg-teal-600 text-white rounded hover:bg-teal-700">Submit</button>
          <button id="locBtn" type="button" class="px-3 py-2 bg-gray-200 rounded">Use current location</button>
          <div id="formStatus" class="text-sm text-gray-500"></div>
        </div>

        <div id="result" class="mt-2"></div>
      </form>
    </div>
  </div>
</main>

<!-- Success Modal -->
<div id="successModal" class="fixed inset-0 hidden items-center justify-center modal-backdrop z-[9999]">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-lg p-6 mx-4">
    <h3 class="text-lg font-semibold">Report submitted</h3>
    <p class="text-sm text-gray-600 mt-2">Your issue has been submitted successfully. Save the tracking ID to follow progress.</p>

    <div class="mt-4 flex items-center justify-between bg-gray-50 rounded p-3">
      <div>
        <div class="text-xs text-gray-500">Tracking ID</div>
        <div id="modalTracking" class="font-mono text-lg"></div>
      </div>
      <div class="flex items-center gap-3">
        <button id="copyBtn" class="px-3 py-2 bg-gray-100 rounded">Copy</button>
        <a id="trackLink" href="#" class="px-3 py-2 bg-teal-600 text-white rounded">Track Now</a>
      </div>
    </div>

    <div class="mt-4 text-right">
      <button id="closeModal" class="px-4 py-2 rounded border">Close</button>
    </div>
  </div>
</div>

<!-- Footer -->
<footer class="bg-gray-900 text-gray-300">
  <div class="max-w-6xl mx-auto px-6 py-10 grid md:grid-cols-3 gap-6">
    <div>
      <div class="flex items-center gap-3">
        <img src="/images/logo.png" alt="Report Local Issues Logo" class="w-10 h-10 rounded-md object-cover shadow bg-white"/>
        <div>
          <div class="text-white font-semibold">Report Local Issues</div>
          <div class="text-xs text-gray-400">Make change happen</div>
        </div>
      </div>
      <p class="mt-4 text-sm text-gray-400">A small civic-tech project to help communities report and track local issues. Built with love.</p>
    </div>

    <div>
      <h4 class="text-sm font-semibold text-white">Quick Links</h4>
      <ul class="mt-3 text-sm space-y-2">
        <li><a href="/submit.html" class="hover:text-white">Report Issue</a></li>
        <li><a href="/track.html" class="hover:text-white">Track Issue</a></li>
        <li><a href="/recent-map.html" class="hover:text-white">Recent Issues</a></li>
        <li><a href="/privacy.html" class="hover:text-white">Privacy policy</a></li>
      </ul>
    </div>

    <div>
      <h4 class="text-sm font-semibold text-white">Contact & Social</h4>
      <p class="mt-3 text-sm text-gray-400">contact@reportlocal.local</p>
      <div class="mt-4 flex items-center gap-3">
        <a href="#" class="p-2 bg-white/5 rounded hover:bg-white/10">
          <!-- twitter -->
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
            <path d="M19.633 7.997c.013.183.013.366.013.55 0 5.62-4.28 12.103-12.103 12.103-2.406 0-4.648-.704-6.532-1.918.334.04.668.066 1.018.066 1.998 0 3.838-.68 5.294-1.822-1.873-.04-3.45-1.27-3.996-2.964.26.04.52.066.792.066.375 0 .75-.053 1.1-.146-1.973-.394-3.457-2.134-3.457-4.217v-.053c.578.32 1.244.52 1.948.547-1.154-.766-1.91-2.074-1.91-3.556 0-.792.213-1.533.587-2.17 2.094 2.57 5.24 4.255 8.774 4.43-.066-.308-.106-.62-.106-.94 0-2.264 1.826-4.098 4.098-4.098 1.178 0 2.243.5 2.99 1.302.93-.178 1.8-.52 2.586-.985-.306.958-.958 1.76-1.81 2.27.826-.092 1.612-.318 2.344-.648-.547.826-1.244 1.55-2.043 2.13z"/>
          </svg>
        </a>
        <a href="#" class="p-2 bg-white/5 rounded hover:bg-white/10">
          <!-- facebook -->
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
            <path d="M22 12a10 10 0 10-11.5 9.9v-7H8v-3h2.5V9.3c0-2.5 1.5-3.9 3.8-3.9 1.1 0 2.3.2 2.3.2v2.6h-1.3c-1.3 0-1.7.8-1.7 1.6V12H19l-.5 3h-2.5v7A10 10 0 0022 12z"/>
          </svg>
        </a>
      </div>
    </div>
  </div>

  <div class="border-t border-gray-800">
    <div class="max-w-6xl mx-auto px-6 py-4 text-xs text-gray-500 flex items-center justify-between">
      <div>© <span id="year"></span> Report Local Issues. All rights reserved.</div>
      <div class="space-x-4">
        <a href="/privacy.html" class="hover:text-white">Privacy</a>
        <a href="/contact.html" class="hover:text-white">Contact</a>
      </div>
    </div>
  </div>
</footer>

<!-- Scripts -->
<script>
  document.getElementById('year').textContent = new Date().getFullYear();

  // mobile nav
  const mobileBtn = document.getElementById('mobileBtn');
  const mobileMenu = document.getElementById('mobileMenu');
  if (mobileBtn) mobileBtn.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));

  // Map + form logic
  (function () {
    // ensure Leaflet available
    if (typeof L === 'undefined') {
      console.error('Leaflet not loaded');
      return;
    }

    const form = document.getElementById('complaintForm');
    const resultDiv = document.getElementById('result');
    const latInput = document.getElementById('latitude');
    const lonInput = document.getElementById('longitude');
    const locBtn = document.getElementById('locBtn');
    const submitBtn = document.getElementById('submitBtn');
    const formStatus = document.getElementById('formStatus');

    // init map
    const map = L.map('mapPicker').setView([13.0827, 80.2707], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    setTimeout(() => { try { map.invalidateSize() } catch(e){} }, 200);

    let marker = null;
    function placeMarker(lat, lng) {
      const nlat = Number(lat), nlng = Number(lng);
      if (!isFinite(nlat) || !isFinite(nlng)) return;
      const fixedLat = Number(nlat.toFixed(6));
      const fixedLng = Number(nlng.toFixed(6));
      if (marker) marker.setLatLng([fixedLat, fixedLng]); else marker = L.marker([fixedLat, fixedLng]).addTo(map);
      map.setView([fixedLat, fixedLng], 15);
      latInput.value = fixedLat;
      lonInput.value = fixedLng;
    }

    map.on('click', e => placeMarker(e.latlng.lat, e.latlng.lng));
    if (latInput.value && lonInput.value) placeMarker(parseFloat(latInput.value), parseFloat(lonInput.value));

    locBtn.addEventListener('click', () => {
      if (!navigator.geolocation) { alert('Geolocation not supported'); return; }
      locBtn.disabled = true; const old = locBtn.textContent; locBtn.textContent = 'Locating...';
      navigator.geolocation.getCurrentPosition(pos => { placeMarker(pos.coords.latitude, pos.coords.longitude); locBtn.disabled = false; locBtn.textContent = old; },
        err => { alert('Unable to get location: ' + (err.message || 'error')); locBtn.disabled = false; locBtn.textContent = old; },
        { timeout: 10000 }
      );
    });

    // modal interactions
    const successModal = document.getElementById('successModal');
    const modalTracking = document.getElementById('modalTracking');
    const copyBtn = document.getElementById('copyBtn');
    const trackLink = document.getElementById('trackLink');
    const closeModal = document.getElementById('closeModal');

    function showModal(trackingId) {
      modalTracking.textContent = trackingId;
      trackLink.href = '/track.html?trackingId=' + encodeURIComponent(trackingId);
      successModal.classList.remove('hidden');
      successModal.classList.add('flex');
    }
    function hideModal() {
      successModal.classList.add('hidden');
      successModal.classList.remove('flex');
    }

    copyBtn.addEventListener('click', () => {
      const text = modalTracking.textContent || '';
      navigator.clipboard.writeText(text).then(() => { copyBtn.textContent = 'Copied'; setTimeout(()=>copyBtn.textContent='Copy',1200); });
    });
    closeModal.addEventListener('click', hideModal);
    successModal.addEventListener('click', (e) => { if (e.target === successModal) hideModal(); }); // click backdrop to close

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      resultDiv.innerHTML = '';
      formStatus.textContent = '';
      submitBtn.disabled = true;
      submitBtn.classList.add('opacity-70');

      // basic client validation
      const name = document.getElementById('name').value.trim();
      const title = document.getElementById('title').value.trim();
      const desc = document.getElementById('description').value.trim();
      if (!name || !title || !desc) {
        resultDiv.innerHTML = `<div class="p-3 bg-red-50 border border-red-200 rounded text-sm">Please fill required fields</div>`;
        submitBtn.disabled = false;
        submitBtn.classList.remove('opacity-70');
        return;
      }

      const data = new FormData();
      data.append('name', name);
      data.append('email', document.getElementById('email').value.trim());
      data.append('phone', document.getElementById('phone').value.trim());
      data.append('title', title);
      data.append('description', desc);
      const lat = latInput.value.trim(), lon = lonInput.value.trim();
      if (lat) data.append('latitude', lat);
      if (lon) data.append('longitude', lon);
      const addr = document.getElementById('address').value.trim();
      if (addr) data.append('address', addr);
      const fileInput = document.getElementById('image');
      if (fileInput.files.length > 0) data.append('image', fileInput.files[0]);

      formStatus.textContent = 'Submitting...';
      try {
        const resp = await fetch('/api/complaints', { method: 'POST', body: data });
        const json = await resp.json();
        if (resp.ok && json.trackingId) {
          // success
          showModal(json.trackingId);
          form.reset();
          if (marker) { map.removeLayer(marker); marker = null; }
          resultDiv.innerHTML = `<div class="p-3 bg-green-50 border border-green-200 rounded text-sm">Submitted! Tracking ID: <strong>${json.trackingId}</strong></div>`;
        } else {
          resultDiv.innerHTML = `<div class="p-3 bg-red-50 border border-red-200 rounded text-sm">Error: ${json.error || JSON.stringify(json)}</div>`;
        }
      } catch (err) {
        console.error('Network error', err);
        resultDiv.innerHTML = `<div class="p-3 bg-red-50 border border-red-200 rounded text-sm">Network error: ${err.message}</div>`;
      } finally {
        submitBtn.disabled = false;
        submitBtn.classList.remove('opacity-70');
        formStatus.textContent = '';
      }
    });
  })();
</script>
</body>
</html>