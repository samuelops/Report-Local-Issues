<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Report Local Issues — Track Issue</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        .status-chip { font-weight:700; font-size:12px; padding:6px 10px; border-radius:9999px; display:inline-flex; align-items:center; gap:8px; }
        .status-submitted { color:#dc2626; background: rgba(220,38,38,0.06); border: 1px solid rgba(220,38,38,0.12); }
        .status-progress { color:#d97706; background: rgba(217,119,6,0.06); border: 1px solid rgba(217,119,6,0.12); }
        .status-resolved { color:#059669; background: rgba(5,150,105,0.06); border: 1px solid rgba(5,150,105,0.12); }
        .status-rejected { color:#6b7280; background: rgba(107,114,128,0.06); border: 1px solid rgba(107,114,128,0.12); }
        .modal-backdrop { background: rgba(0,0,0,0.5); }

        /* nav link base + hover */
  .nav-link {
    position: relative;
    padding: 6px 4px;
    transition: color 180ms ease, background-color 180ms ease;
  }
  .nav-link::after {
    /* subtle underline on hover/active */
    content: "";
    position: absolute;
    left: 0;
    bottom: -4px;
    height: 2px;
    width: 0%;
    background: linear-gradient(90deg, #06b6d4, #10b981);
    transition: width 220ms ease;
    border-radius: 2px;
  }
  .nav-link:hover {
    color: #0ea5a4; /* teal-ish hover color */
  }
  .nav-link:hover::after { width: 100%; }
    </style>
</head>
<body class="antialiased text-gray-800 bg-gray-50">

<!-- Header -->
<header class="bg-white/60 backdrop-blur sticky top-0 z-30">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
        <a href="/" class="flex items-center gap-3">
            <img src="/images/logo.png" alt="Logo" class="w-10 h-10 rounded-md object-cover shadow bg-white"/>
            <div>
                <div class="text-sm font-semibold">Report Local Issues</div>
                <div class="text-xs text-gray-500 -mt-1">Community → Action</div>
            </div>
        </a>

        <nav class="hidden md:flex items-center gap-6 text-sm">
            <a href="/" class="nav-link">Home</a>
            <a href="/submit.html" class="nav-link">Report Issue</a>
            <a href="/track.html" class="text-teal-700 font-medium">Track Issue</a>
            <a href="/recent-map.html" class="nav-link">Recent Issues</a>
            <a href="/admin/complaints" class="px-3 py-1 rounded text-sm bg-gray-100 nav-link">Admin</a>
        </nav>

        <div class="md:hidden">
            <button id="mobileBtn" aria-label="Open menu" class="p-2 rounded-md hover:bg-gray-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M4 6h16M4 12h16M4 18h16"/>
                </svg>
            </button>
        </div>
    </div>
    <div id="mobileMenu" class="md:hidden hidden bg-white/95 border-t">
        <div class="px-4 py-3 flex flex-col gap-2">
            <a href="/" class="py-2">Home</a>
            <a href="/submit.html" class="py-2 nav-link">Report Issue</a>
            <a href="/track.html" class="py-2 nav-link">Track Issue</a>
            <a href="/recent-map.html" class="py-2 nav-link">Recent Issues</a>
            <a href="/admin/complaints" class="py-2 nav-link">Admin</a>
        </div>
    </div>
</header>

<!-- Page content -->
<main class="py-12">
    <div class="max-w-4xl mx-auto px-4">

        <!-- search card -->
        <div class="bg-white shadow rounded-lg p-5 mb-6">
            <h1 class="text-xl font-semibold mb-2">Track your complaint</h1>
            <p class="text-sm text-gray-600 mb-4">Enter your tracking ID to see the current status and details.</p>

            <form id="trackForm" class="flex gap-3 items-center">
                <input id="trackingInput" placeholder="Enter tracking ID (e.g. CIT-2025-xxxx)" class="flex-1 p-2 border rounded-md" />
                <button id="trackBtn" class="px-4 py-2 bg-teal-600 text-white rounded">Track</button>
                <a href="/submit.html" class="ml-2 text-sm text-gray-600 hover:text-gray-800">Report another</a>
            </form>

            <div id="trackMessage" class="mt-3 text-sm text-red-600"></div>
        </div>

        <!-- result area -->
        <div id="resultArea" class="hidden space-y-6">

            <!-- top summary -->
            <div class="bg-white shadow rounded-lg p-4 flex flex-col md:flex-row gap-4">
                <div class="md:w-2/3">
                    <div class="flex items-start justify-between">
                        <div>
                            <div id="titleText" class="text-lg font-semibold">—</div>
                            <div class="text-sm text-gray-500 mt-1">
                                <span id="locationText">—</span> • <span id="timeText">—</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div id="statusChip" class="status-chip status-submitted">Status</div>
                            <div class="mt-2 text-xs text-gray-500">Tracking ID: <span id="trackingText" class="font-mono"></span></div>
                        </div>
                    </div>

                    <div class="mt-4 text-gray-700" id="descriptionText">—</div>

                    <div class="mt-4 text-sm text-gray-600">
                        <div><strong>Submitted by:</strong> <span id="submittedBy">—</span></div>
                        <div class="mt-1"><strong>Contact:</strong> <span id="contactInfo">—</span></div>
                    </div>
                </div>

                <div class="md:w-1/3 space-y-3">
                    <div id="imageWrap" class="w-full h-40 bg-gray-100 rounded overflow-hidden flex items-center justify-center">
                        <!-- image inserted here -->
                    </div>

                    <div class="flex gap-2">
                        <button id="copyBtn" class="flex-1 px-3 py-2 bg-gray-100 rounded">Copy ID</button>
                        <a id="shareBtn" class="flex-1 px-3 py-2 bg-teal-600 text-white rounded text-center">Share</a>
                    </div>
                </div>
            </div>

            <!-- map and admin notes -->
            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-white shadow rounded-lg p-4">
                    <h3 class="font-semibold mb-3">Location</h3>
                    <div id="detailMap" class="w-full h-64 rounded border"></div>
                    <div class="mt-2 text-sm text-gray-600" id="addressText"></div>
                </div>

                <div class="bg-white shadow rounded-lg p-4">
                    <h3 class="font-semibold mb-3">Admin Notes & Timeline</h3>
                    <div id="adminNotes" class="text-sm text-gray-700 min-h-[120px]"></div>
                    <div class="mt-4 text-xs text-gray-500">
                        <div>Created: <span id="createdAt">—</span></div>
                        <div class="mt-1">Last updated: <span id="updatedAt">—</span></div>
                    </div>
                </div>
            </div>

        </div>

        <!-- not found / error -->
        <div id="notFound" class="hidden bg-white shadow rounded-lg p-6 text-center text-gray-600">
            <div class="text-xl font-semibold mb-2">Tracking ID not found</div>
            <div class="mb-4">Double-check the ID. If you still have trouble, contact support.</div>
            <div><a href="/submit.html" class="px-4 py-2 bg-teal-600 text-white rounded">Report a new issue</a></div>
        </div>

    </div>
</main>

<!-- Footer -->
<footer class="bg-gray-900 text-gray-300 mt-12">
    <div class="max-w-6xl mx-auto px-6 py-10 grid md:grid-cols-3 gap-6">
        <div>
            <div class="flex items-center gap-3">
                <img src="/images/logo.png" alt="logo" class="w-10 h-10 rounded-md object-cover shadow bg-white"/>
                <div>
                    <div class="text-white font-semibold">Report Local Issues</div>
                    <div class="text-xs text-gray-400">Make change happen</div>
                </div>
            </div>
            <p class="mt-4 text-sm text-gray-400">A civic-tech project to help communities report and track issues. Built with care.</p>
        </div>

        <div>
            <h4 class="text-sm font-semibold text-white">Quick Links</h4>
            <ul class="mt-3 text-sm space-y-2">
                <li><a href="/submit.html" class="hover:text-white">Report Issue</a></li>
                <li><a href="/track.html" class="hover:text-white">Track Issue</a></li>
                <li><a href="/recent-map.html" class="hover:text-white">Recent Issues</a></li>
            </ul>
        </div>

        <div>
            <h4 class="text-sm font-semibold text-white">Contact</h4>
            <p class="mt-3 text-sm text-gray-400">contact@reportlocal.local</p>
        </div>
    </div>

    <div class="border-t border-gray-800">
        <div class="max-w-6xl mx-auto px-6 py-4 text-xs text-gray-500 flex items-center justify-between">
            <div>© <span id="year"></span> Report Local Issues. All rights reserved.</div>
            <div class="space-x-4">
                <a href="/privacy.html" class="hover:text-white">Privacy</a>
                <a href="/contact.html" class="hover:text-white">Contact</a>
            </div>
        </div>
    </div>
</footer>

<!-- Scripts -->
<script>
    document.getElementById('year').textContent = new Date().getFullYear();
    // mobile nav
    const mobileBtn = document.getElementById('mobileBtn');
    const mobileMenu = document.getElementById('mobileMenu');
    if (mobileBtn) mobileBtn.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));

    // helpers
    function qs(key) {
      const params = new URLSearchParams(window.location.search);
      return params.get(key);
    }

    function formatTime(iso) {
      if (!iso) return '—';
      try {
        const d = new Date(iso);
        return d.toLocaleString();
      } catch (e) { return iso; }
    }

    function statusClass(status) {
      if (!status) return 'status-submitted';
      const s = status.toUpperCase();
      if (s === 'SUBMITTED') return 'status-submitted';
      if (s === 'IN_PROGRESS' || s === 'IN-PROGRESS') return 'status-progress';
      if (s === 'RESOLVED') return 'status-resolved';
      if (s === 'REJECTED') return 'status-rejected';
      return 'status-submitted';
    }

    function statusLabel(status) {
      if (!status) return 'Reported';
      const s = status.toUpperCase();
      if (s === 'SUBMITTED') return 'Reported';
      if (s === 'IN_PROGRESS' || s === 'IN-PROGRESS') return 'In Progress';
      if (s === 'RESOLVED') return 'Resolved';
      if (s === 'REJECTED') return 'Rejected';
      return status;
    }

    // main
    (function () {
      const trackForm = document.getElementById('trackForm');
      const trackingInput = document.getElementById('trackingInput');
      const trackMessage = document.getElementById('trackMessage');
      const resultArea = document.getElementById('resultArea');
      const notFound = document.getElementById('notFound');

      // quick map variables
      let detailMap = null;
      let detailMarker = null;

      // set input from querystring if present
      const qid = qs('trackingId');
      if (qid) {
        trackingInput.value = qid;
        // auto-run search
        fetchAndRender(qid);
      }

      trackForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const id = trackingInput.value.trim();
        if (!id) { trackMessage.textContent = 'Please enter a tracking ID.'; return; }
        trackMessage.textContent = '';
        fetchAndRender(id);
      });

      // copy/share
      const copyBtn = document.getElementById('copyBtn');
      const shareBtn = document.getElementById('shareBtn');
      copyBtn.addEventListener('click', () => {
        const id = document.getElementById('trackingText').textContent || '';
        if (!id) return;
        navigator.clipboard.writeText(id).then(() => { copyBtn.textContent = 'Copied'; setTimeout(()=>copyBtn.textContent='Copy ID',1200); });
      });
      shareBtn.addEventListener('click', () => {
        const id = document.getElementById('trackingText').textContent || '';
        if (!id) return;
        const url = window.location.origin + '/track.html?trackingId=' + encodeURIComponent(id);
        if (navigator.share) {
          navigator.share({ title: 'Track complaint ' + id, url }).catch(()=>window.open(url,'_blank'));
        } else {
          window.open(url,'_blank');
        }
      });

      async function fetchAndRender(trackingId) {
        resultArea.classList.add('hidden');
        notFound.classList.add('hidden');
        trackMessage.textContent = 'Loading...';

        try {
          const resp = await fetch('/api/complaints/' + encodeURIComponent(trackingId));
          if (resp.status === 404) {
            trackMessage.textContent = '';
            notFound.classList.remove('hidden');
            return;
          }
          const data = await resp.json();
          // render
          document.getElementById('titleText').textContent = data.title || '—';
          document.getElementById('locationText').textContent = (data.address || (data.latitude && data.longitude ? `(${data.latitude}, ${data.longitude})` : 'No location'));
          document.getElementById('timeText').textContent = formatTime(data.createdAt);
          document.getElementById('descriptionText').textContent = data.description || '—';
          document.getElementById('submittedBy').textContent = data.name || '—';
          document.getElementById('contactInfo').textContent = (data.email || data.phone) || '—';
          document.getElementById('trackingText').textContent = data.trackingId || trackingId;

          // status
          const chip = document.getElementById('statusChip');
          chip.textContent = statusLabel(data.status);
          chip.className = 'status-chip ' + statusClass(data.status);

          // image
          const imageWrap = document.getElementById('imageWrap');
          imageWrap.innerHTML = '';
          if (data.imageUrl) {
            const img = document.createElement('img');
            img.src = data.imageUrl;
            img.alt = 'issue image';
            img.className = 'w-full h-full object-cover';
            imageWrap.appendChild(img);
          } else {
            imageWrap.innerHTML = '<div class="text-sm text-gray-500">No image provided</div>';
          }

          // admin notes & times
          document.getElementById('adminNotes').textContent = data.adminNotes || 'No admin notes yet.';
          document.getElementById('createdAt').textContent = formatTime(data.createdAt);
          document.getElementById('updatedAt').textContent = formatTime(data.updatedAt);

          // map
          const lat = data.latitude, lon = data.longitude;
          const addressText = document.getElementById('addressText');
          addressText.textContent = data.address || '';

          if (lat && lon) {
            // lazy init map
            if (!detailMap) {
              detailMap = L.map('detailMap').setView([lat, lon], 15);
              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
              }).addTo(detailMap);
            }
            if (detailMarker) detailMap.removeLayer(detailMarker);
            detailMarker = L.marker([lat, lon]).addTo(detailMap);
            detailMap.setView([lat, lon], 15);
            setTimeout(()=>{ try { detailMap.invalidateSize(); } catch(e){} }, 120);
          } else {
            // no location
            document.getElementById('detailMap').innerHTML = '<div class="text-sm text-gray-500 p-4">No location provided for this complaint.</div>';
            if (detailMap) { try { detailMap.remove(); detailMap = null; } catch(e){} }
          }

          // show result
          resultArea.classList.remove('hidden');
          trackMessage.textContent = '';
          // update URL without reload
          const newUrl = window.location.pathname + '?trackingId=' + encodeURIComponent(data.trackingId);
          history.replaceState({}, '', newUrl);

        } catch (err) {
          console.error(err);
          trackMessage.textContent = 'Network error. Please try again.';
        }
      }
    })();
</script>
</body>
</html>
